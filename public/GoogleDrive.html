<!DOCTYPE html>
<html>

<head>
  <title>Drive API Quickstart</title>
  <meta charset="utf-8" />
</head>

<body>
  <p>Drive API Quickstart</p>

  <!--Add buttons to initiate auth sequence and sign out-->
  <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
  <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
  <button id="export_button" onclick="handleExportClick()">Export Data</button>
  <button id="import_button" onclick="handleImportClick()">Import Data</button>

  <pre id="content" style="white-space: pre-wrap;"></pre>

  <script type="text/javascript">
    const CLIENT_ID = '507502242382-a7d868j5089106u313q7hd6js3i375l2.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCMehcHxbFkrej2jq_CT4TuAqQz01MTW6g';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    document.getElementById('authorize_button').style.visibility = 'hidden';
    document.getElementById('signout_button').style.visibility = 'hidden';
    document.getElementById('export_button').style.visibility = 'hidden';
    document.getElementById('import_button').style.visibility = 'hidden';

    /**
     * Callback after api.js is loaded.
     */
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    /**
     * Callback after the API client is loaded. Loads the
     * discovery doc to initialize the API.
     */
    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    /**
     * Callback after Google Identity Services are loaded.
     */
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // defined later
      });
      gisInited = true;
      maybeEnableButtons();
    }

    /**
     * Enables user interaction after all libraries are loaded.
     */
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('authorize_button').style.visibility = 'visible';
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        document.getElementById('signout_button').style.visibility = 'visible';
        document.getElementById('export_button').style.visibility = 'visible';
        document.getElementById('import_button').style.visibility = 'visible';
        document.getElementById('authorize_button').innerText = 'Refresh';
        await listFiles();
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('content').innerText = '';
        document.getElementById('authorize_button').innerText = 'Authorize';
        document.getElementById('signout_button').style.visibility = 'hidden';
        document.getElementById('export_button').style.visibility = 'hidden';
        document.getElementById('import_button').style.visibility = 'hidden';
      }
    }

    function handleExportClick() {
      const data = [];
      Object.keys(localStorage).sort().forEach(key => {
        data[key] = localStorage.getItem(key);
      })
      createAppData('localStorage.json', data, 'application/json');
    }

    function makeMultipartBody(parts, boundary) {
      const result = [];

      parts.forEach(part => {
        const name = part[0];
        const body = part[1];
        const headers = part[2];
        result.push(`--${boundary}`);
        Object.keys(headers).forEach(key => {
          result.push(`${key}: ${headers[key]}`);
        })
        result.push('');
        result.push(JSON.stringify(body));
      })
      result.push(`--${boundary}--`);

      return result.join('\r\n');
    }

    async function createAppData(name, appdata, contentType) {
      const boundary = '----====----====----';

      const parts = [];
      parts.push(['metadata', {
        name: name,
        parents: ['appDataFolder'],
      }, { 'Content-Type': 'application/json' }]);
      parts.push(['media', appdata, { 'Content-Type': contentType }]);

      const multipartBody = makeMultipartBody(parts, boundary);

      let response;
      try {
        response = await gapi.client.request({
          path: '/upload/drive/v3/files',
          method: 'POST',
          params: {
            uploadType: 'multipart',
          },
          headers: {
            'Content-Type': `multipart/related; boundary=${boundary}`
          },
          body: multipartBody,
        });
        console.log(response);
        document.getElementById('content').innerText = `${response.result.id}, ${response.result.name}`;
      } catch (err) {
        document.getElementById('content').innerText = err.message;
        return;
      }
    }

    function handleImportClick() {

    }

    /**
     * Print appData for first 10 files.
     */
    async function listFiles() {
      let response;
      try {
        response = await gapi.client.drive.files.list({
          'pageSize': 10,
          'fields': 'files(id, name, modifiedTime)',
          'spaces': 'appDataFolder',
        });
      } catch (err) {
        document.getElementById('content').innerText = err.message;
        return;
      }
      const files = response.result.files;
      if (!files || files.length == 0) {
        document.getElementById('content').innerText = 'No files found.';
        return;
      }
      // Flatten to string to display
      const output = files.reduce(
        (str, file) => `${str}${file.name} (${file.id}) ${file.modifiedTime}\n`,
        'Files:\n');
      document.getElementById('content').innerText = output;
    }
  </script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>