<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>げんろーて - Genshin Impact Rotation Visualizer</title>
    <link href="styles/base-style.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <reference path="JQuery.d.ts"></reference>
    <style type="text/css">
        body {
            color: blanchedalmond;
            background-color: black;
        }

        #main {
            background: linear-gradient(to top, #3d3d3b, #141414);
            padding: 2rem;
        }

        a:link {
            color: blanchedalmond;
        }

        a:visited {
            color: blanchedalmond;
        }

        #rotation-list-area {
            text-align: left;
        }

        div.character-line {
            position: relative;
            max-width: 100%;
            text-align: left;
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: 10px solid;
        }

        div.character-line img.face {
            width: 80px;
            height: 80px;
            vertical-align: top;
        }

        div.character-line div.actions {
            position: absolute;
            left: 80px;
            top: 0;
        }

        .actions div.action {
            position: absolute;
            border-radius: 40%;
            bottom: -96px;
            text-align: center;
        }

        div.action img.action {
            width: 48px;
            /* height: 64px; */
            vertical-align: top;
            margin-top: auto;
            margin-bottom: auto;
        }

        div.action p {
            font-size: 3rem;
            color: black;
            margin: 0;
        }
    </style>
</head>

<body>
    <div id="main">
        <fieldset style="margin: 1rem; position: relative;">
            <legend>げんろーて - Genshin Impact Rotation Visualizer</legend>
            <p style="text-align: left;"><a href="/gencalc/">げんかるく</a> </p>
        </fieldset>

        <label for="rotation-new">Rotation Text:</label>
        <textarea id="rotation-new" name="rotation-new" rows="8" cols="100" autocapitalize="words">
        </textarea>

        <div id="rotation-list-area">
            <ul>
                <li>
                    <pre>
                        Yelan E > Gorou Q > Albedo E > Yelan QN > Noelle Q N3E N3D > Yelan EN > Gorou EN > Noelle 2N3D
                    </pre>
                </li>
                <li>
                    <pre>
                        雷電将軍 E > 行秋 QE > ベネット EQ > 香菱 EQ > ベネット EN > 雷電将軍 Q 4N4C
                    </pre>
                </li>
            </ul>
        </div>

        <label for="name-new">NAME:</label>
        <input type="text" id="name-new" minlength="1" maxlength="32" size="32">

        <button type="button" id="save-new">SAVE</button>

        <div id="rotaion-result-area" style="min-height: 440px;">
        </div>

        <h2>SAVE DATA</h2>
        <div id="save-data-area">
        </div>

        <h2>SAMPLES</h2>
        <div id="sample-data-area">
        </div>
    </div>

    <script>
        function selectorEscape(val) {
            return val.replace(/[ !"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~]/g, '\\$&');
        }

        const FACE_HTML_TEMPLATE = `<img src="$1" class="face" style="background-image:url($2); background-size:contain;">`;

        const TEAM_COMPACT_HTML = `<table>
            <tr>
                <td colspan="2">$1</td>
            </tr>
            <tr>
                <td>$2</td>
                <td>$3</td>
            </tr>
        </table>
        `;

        var CharacterMaster;
        var WeaponMaster = [];
        var ArtifactSetMaster;
        var ArtifactMainMaster;
        var ArtifactSubMaster;
        var EnemyMaster;
        var ElementalResonanceMaster;
        var ElementalReactionMaster;
        var OptionMaster1;
        var OptionMaster2;
        var TeamOptionMaster;
        var characterMatchMap = new Map();

        const KQM_SPLIT_RE1 = new RegExp(/\s+>\s+/);

        function analyzeCharacterName(str) {
            let result;
            const str2 = str.toLowerCase();
            for (let entry of characterMatchMap.entries()) {
                entry[1].forEach(v => {
                    if (str2.startsWith(v.toLowerCase())) {
                        result = entry[0];
                    }
                });
                if (result) {
                    break;
                };
            }
            return result;
        }

        function analyzeKqmNotation(kqm) {
            let result = new Map();

            kqm = kqm.replace(/\/\*(.*)\*\//g, function (match, p1) {
                return '/* ' + p1.trim().replace('>', '&gt;') + ' */';
            });
            kqm = kqm.trim().replace(/\n/g, ' > ');

            let start = 1;
            const kqmSplitted = kqm.split(KQM_SPLIT_RE1);
            console.log(kqmSplitted);
            kqmSplitted.forEach(e1 => {
                if (e1.startsWith('/*')) {
                    e1 = e1.replace(/^\/\*.+?\*\//, '');
                }
                const character = analyzeCharacterName(e1);
                if (!result.has(character)) {
                    result.set(character, []);
                }

                let nameArr = characterMatchMap.get(character).filter(s => e1.toLowerCase().startsWith(s.toLowerCase()));
                let n = 1;
                if (nameArr) {
                    nameArr.forEach(name => {
                        let nTemp = name.split(' ').length;
                        if (n < nTemp) {
                            n = nTemp;
                        }
                    });
                }
                let actions = e1.split(' ');
                for (let i = 0; i < n; i++) {
                    actions.shift();
                }

                actions.forEach(action => {
                    let subArr = [];
                    let repeatTimesStr = '';
                    const actionChars = action.split('');
                    for (let i = 0; i < actionChars.length; i++) {
                        if (!$.isNumeric(actionChars[i])) {
                            break;
                        }
                        repeatTimesStr = repeatTimesStr + actionChars[i];
                    }
                    for (let i = 0; i < repeatTimesStr.length; i++) {
                        actionChars.shift();
                    }
                    actionChars.forEach(a => {
                        // N 通常攻撃
                        // C 重撃
                        // E 元素スキル
                        // Q 元素爆発
                        // D ダッシュ
                        // J ジャンプ
                        // W 歩く
                        if ('NEQ'.indexOf(a.toUpperCase()) != -1) {
                            subArr.push(a.toUpperCase());
                        } else if ('CDJW'.indexOf(a.toUpperCase()) != -1) {
                            if (subArr[subArr.length - 1].startsWith('N')) {
                                subArr[subArr.length - 1] = subArr[subArr.length - 1] + a;
                            } else {
                                subArr.push(a.toUpperCase());
                            }
                        } else if ($.isNumeric(a)) {
                            if (subArr[subArr.length - 1] == 'N') {
                                subArr[subArr.length - 1] = subArr[subArr.length - 1] + a;
                            }
                        }
                    });
                    let repeatTimes = 1;
                    if (repeatTimesStr) {
                        repeatTimes = Number(repeatTimesStr);
                    }
                    for (let i = 0; i < repeatTimes; i++) {
                        subArr.forEach(a => {
                            result.get(character).push([start++, a]);
                        });
                    }
                });

            });

            return result;
        }

        function createElementCharacterLine(character) {
            const divElem = document.createElement('div');
            divElem.className = 'character-line';
            divElem.style.borderBottomColor = ELEMENT_COLOR[CharacterMaster[character]['元素']];
            divElem.style.borderImage = 'linear-gradient(135deg,' + ELEMENT_COLOR[CharacterMaster[character]['元素']] + ',#555555)';
            divElem.style.borderImageSlice = '1';

            const importVal = CharacterMaster[character]['import'];
            const src = importVal.replace(/^data\/characters/, 'images/characters/face').replace(/json$/, 'png');
            const backgroundImageUrl = 'images/star' + CharacterMaster[character]['レアリティ'] + '-bg.png';
            const imgHtml = FACE_HTML_TEMPLATE.replace('$1', src).replace('$2', backgroundImageUrl);

            const imgElem = document.createElement('img');
            imgElem.className = 'face';
            imgElem.src = importVal.replace(/^data\/characters/, 'images/characters/face').replace(/json$/, 'png');
            imgElem.alt = characterMatchMap.get(character)[1];
            imgElem.style.backgroundImage = 'url(' + backgroundImageUrl + ')';
            imgElem.style.backgroundSize = 'contain';
            divElem.appendChild(imgElem);

            const actionsDivElem = document.createElement('div');
            actionsDivElem.className = 'actions';
            divElem.appendChild(actionsDivElem);

            return divElem;
        }

        const NORMAL_ATTACK_SRC = {
            片手剣: 'images/characters/NormalAttack_sword.png',
            両手剣: 'images/characters/NormalAttack_claymore.png',
            長柄武器: 'images/characters/NormalAttack_polearm.png',
            弓: 'images/characters/NormalAttack_bow.png',
            法器: 'images/characters/NormalAttack_catalyst.png'
        };

        const ELEMENT_COLOR = {
            炎: '#d2655a',
            水: '#559cc9',
            風: '#3aaf7a',
            雷: '#b681df',
            草: '',
            氷: '#63beb4',
            岩: '#df8f37'
        };

        const TIME_UNIT = 48;
        const ACTION_TIME = {
            C: 1.5 * TIME_UNIT,
            E: 1 * TIME_UNIT,
            Q: 1.5 * TIME_UNIT,
            D: 0.2 * TIME_UNIT,
            J: 0.3 * TIME_UNIT,
            W: 0.3 * TIME_UNIT
        };
        const NORMAL_ATTACK_TIME = {
            片手剣: 0.4 * TIME_UNIT,
            両手剣: 0.9 * TIME_UNIT,
            長柄武器: 0.4 * TIME_UNIT,
            弓: 0.4 * TIME_UNIT,
            法器: 0.75 * TIME_UNIT
        };

        function createElementAction(character, start, action, actionTime) {
            const divElem = document.createElement('div');
            divElem.className = 'action';
            divElem.style.width = actionTime + 'px';
            divElem.style.left = start + 'px';
            divElem.style.backgroundColor = ELEMENT_COLOR[CharacterMaster[character]['元素']];

            const importVal = CharacterMaster[character]['import'];
            const imgDir = importVal.replace(/^data\/characters/, 'images/characters').replace(/.json$/, '/');
            let src;
            if (action.startsWith('N') || action == 'C') {
                src = NORMAL_ATTACK_SRC[CharacterMaster[character]['武器']];
            } else if (action == 'E') {
                src = imgDir + 'ElementalSkill.png';
            } else if (action == 'Q') {
                src = imgDir + 'ElementalBurst.png';
            }
            if (src) {
                const imgElem = document.createElement('img');
                imgElem.className = 'action';
                imgElem.src = src;
                imgElem.alt = action;
                if (actionTime < 64) {
                    imgElem.style.width = actionTime + 'px';
                    // imgElem.style.height = actionTime + 'px';
                }
                divElem.appendChild(imgElem);

                const pElem = document.createElement('p');
                pElem.innerHTML = action;
                divElem.appendChild(pElem);
            }

            return divElem;
        }

        TEAM_NOTAION_TEMPLATE = {
            id: '',
            name: '',
            data: '',
            description: '',
            sort_order: 0,
            updated_at: null
        }

        function displayTeam(data, opt_editable = false) {
            const divElem = document.createElement('div');
            divElem.className = 'team';
            divElem.id = data['id'];
        }

        function displayTeamCompact(data) {
            const divElem = document.createElement('div');
            if ('name' in data) {
                const nameElem = document.createElement('p');
                p.innerHTML = name;
                divElem.appendChild(nameElem);
            }
            if ('data' in data) {
                const faceElemArr = [];
                const analyzedMap = analyzeKqmNotation(data['data']);
                analyzedMap.forEach((value, key) => {
                    faceElemArr.push(create)
                });

            }
            if ('description' in data) {

            }
        }

        async function init() {
            const responses = await Promise.all([
                'data/CharacterMaster.json',
                'data/SwordMaster.json',
                'data/ClaymoreMaster.json',
                'data/PolearmMaster.json',
                'data/BowMaster.json',
                'data/CatalystMaster.json',
                'data/ArtifactSetMaster.json',
                'data/ArtifactMainMaster.json',
                'data/ArtifactSubMaster.json',
                'data/EnemyMaster.json',
                'data/ElementalResonanceMaster.json',
                'data/ElementalReactionMaster.json',
                'data/OptionMaster1.json',
                'data/OptionMaster2.json',
                'data/TeamOptionMaster.json'
            ].map(url => fetch(url).then(resp => resp.json())));

            CharacterMaster = responses[0];
            WeaponMaster['片手剣'] = responses[1];
            WeaponMaster['両手剣'] = responses[2];
            WeaponMaster['長柄武器'] = responses[3];
            WeaponMaster['弓'] = responses[4];
            WeaponMaster['法器'] = responses[5];
            ArtifactSetMaster = responses[6];
            ArtifactMainMaster = responses[7];
            ArtifactSubMaster = responses[8];
            EnemyMaster = responses[9];
            ElementalResonanceMaster = responses[10];
            ElementalReactionMaster = responses[11];
            OptionMaster1 = responses[12];
            OptionMaster2 = responses[13];
            TeamOptionMaster = responses[14];

            Object.keys(CharacterMaster).forEach(key => {
                const importVal = CharacterMaster[key]['import'];
                const splitted = importVal.split('_');
                const mapValue = [];
                mapValue.push(key);
                const name1 = splitted[splitted.length - 1].replace('.json', '');
                mapValue.push(name1);
                const name2 = name1.split(/(?=[A-Z])/).join(' ');
                if (name2 != name1) {
                    mapValue.push(name2);
                }
                if (name2.indexOf(' ') != -1) {
                    const nameSplitted = name2.split(' ');
                    mapValue.push(nameSplitted[0]);
                    mapValue.push(nameSplitted[1]);
                }
                characterMatchMap.set(key, mapValue);
            });

            console.log(characterMatchMap);
        };

        const rotationTextareaOnChange = function () {
            if ($(this).val()) {
                const resultAreaElem = document.getElementById('rotaion-result-area');
                $(resultAreaElem).html('');

                let analyzedMap = analyzeKqmNotation($(this).val());
                console.log(analyzedMap);

                const actionTimeMap = new Map();
                analyzedMap.forEach((value, key) => {
                    value.forEach(action => {
                        let actionTime = 0;
                        if (action[1] in ACTION_TIME) {
                            actionTime = ACTION_TIME[action[1]];
                        } else {
                            const nRe = new RegExp(/^N(\d*)([CDJW]*)/);
                            let nRet = nRe.exec(action[1]);
                            if (nRet) {
                                if (nRet[1]) {
                                    actionTime = NORMAL_ATTACK_TIME[CharacterMaster[key]['武器']] * Number(nRet[1]);
                                } else {
                                    actionTime = NORMAL_ATTACK_TIME[CharacterMaster[key]['武器']];
                                }
                                if (nRet[2]) {
                                    if (nRet[2].indexOf('C') != -1) {
                                        actionTime += NORMAL_ATTACK_TIME[CharacterMaster[key]['武器']] * 2;
                                    }
                                    actionTime += 0.2 * TIME_UNIT * nRet[2].length;
                                }
                            }
                        }
                        console.log(action, actionTime, typeof actionTime);
                        actionTimeMap.set(action[0], actionTime);
                    });
                });

                const startMap = new Map();
                actionTimeMap.forEach((value, key) => {
                    let newValue = 0;
                    for (let i = 1; i < key; i++) {
                        newValue += Number(actionTimeMap.get(i));
                    }
                    startMap.set(key, newValue);
                });

                let start = 0;
                analyzedMap.forEach((value, key) => {
                    const characterLineElem = createElementCharacterLine(key);
                    resultAreaElem.appendChild(characterLineElem);
                    value.forEach(action => {
                        const elem = createElementAction(key, startMap.get(action[0]), action[1], actionTimeMap.get(action[0]));
                        $(characterLineElem).find('.actions').append(elem);
                    });
                });
            }
        };

        const saveButtonOnClick = function () {
            const id = $(this).attr('id');
            const suffix = id.substring(id.indexOf('-') + 1);
            const key = String($(selectorEscape('#name-' + suffix)).val()).trim();
            const value = String($(selectorEscape('#rotation-' + suffix)).val()).trim();
            if (!key || !value) {
                return;
            }
            $(selectorEscape('#name-' + suffix)).val(key);
            $(selectorEscape('#rotation-' + suffix)).val(value);
            localStorage.setItem(key, value);
        };

        window.onload = () => {
            init();

            $(document).on('change', '#rotation-new', rotationTextareaOnChange);
            $(document).on('click', '#save-new', saveButtonOnClick);
        };

    </script>
</body>

</html>