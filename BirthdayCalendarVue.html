<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Birthday Calendar - Genshin Impact</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yusei+Magic&display=swap" rel="stylesheet">
    <link href="styles/base-style.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <style>
        body {
            color: blanchedalmond;
            background-color: black;
            font-size: 2rem;
        }

        #main {
            background: linear-gradient(to top, #3d3d3b, #141414);
            margin: 0 auto;
        }

        #main {
            font-family: 'Yusei Magic', sans-serif;
        }

        table.calendar {
            width: 100%;
        }

        table.calendar tr td {
            width: calc(100% / 7);
        }

        table.calendar tr td img {
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="main">
        <div id="year">
            <h2>
                <button type="button" @click="previous"><span class="material-symbols-outlined"> navigate_before
                    </span></button>
                &emsp;
                {{year}}
                &emsp;
                <button type="button" @click="next"><span class="material-symbols-outlined"> navigate_next
                    </span></button>
            </h2>
        </div>

        <div id="birthday-calendar">
            <template v-for="(month, index) in calendar">
                <h3>{{index + 1}}</h3>
                <table class="calendar">
                    <tr>
                        <th class="sunday">Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th class="saturday">Sat</th>
                    </tr>
                    <tr v-for="week in month">
                        <td class="day" v-for="day in week">
                            <template v-if="day.name">
                                <img :src="day.url" :alt="day.name">
                            </template>
                            <template v-else>
                                <img src="data:image/gif;base64,R0lGODlhAQABAGAAACH5BAEKAP8ALAAAAAABAAEAAAgEAP8FBAA7"
                                    :alt="day.day">
                                <p>{{day.day}}</p>
                            </template>
                        </td>
                    </tr>
                </table>
            </template>
        </div>
    </div>

    <script>
        const VISION_IMG_SRC = {
            炎: 'images/element_pyro.png',
            水: 'images/element_hydro.png',
            風: 'images/element_anemo.png',
            雷: 'images/element_electro.png',
            草: 'images/element_dendro.png',
            氷: 'images/element_cryo.png',
            岩: 'images/element_geo.png'
        };

        var キャラクターMaster = {};
        var CharacterImageList = [];

        function buildRandomTeamList(excludeList) {
            const excludeNames = [];
            if (excludeList) {
                for (entry of excludeList) {
                    excludeNames.push(entry.name);
                }
            }
            const randomTeamIndexSet = new Set();
            while (randomTeamIndexSet.size < 4) {
                const newIndex = Math.floor(Math.random() * CharacterImageList.length);
                const name = CharacterImageList[newIndex].name;
                if ((キャラクター所持数 - excludeNames.length) > 9) {
                    if (name in キャラクター所持状況ObjVar) {
                        if (キャラクター所持状況ObjVar[name] == null) continue;
                    }
                    if (excludeNames.includes(name)) continue;
                }
                if (name.startsWith('旅人')) {
                    let isPresent = false;
                    for (entry of randomTeamIndexSet) {
                        if (CharacterImageList[entry].name.startsWith('旅人')) {
                            isPresent = true;
                            break;
                        }
                    }
                    if (isPresent) continue;
                }
                randomTeamIndexSet.add(newIndex);
            }

            const result = [];
            for (entry of randomTeamIndexSet) {
                result.push(CharacterImageList[entry]);
            }
            console.debug('buildRandomTeamList', result);
            return result;
        }

        function getDayList(year, month) {
            const weeks = [];
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0, 0, 0, 0, 0);
            let week = [];
            for (let dayOfWeek = 0; dayOfWeek < firstDayOfMonth.getDay(); dayOfWeek++) {
                week.push({});
            }
            for (let day = 1; day < lastDayOfMonth.getDate(); day++) {
                if (week.length == 7) {
                    weeks.push(week);
                    week = [];
                }
                const dayObj = {
                    day: day
                };
                for (let characterUrl of CharacterImageList) {
                    if (characterUrl['birthday']) {
                        const splitted = characterUrl['birthday'].split('/');
                        if (month == (splitted[0] - 1) && day == splitted[1]) {
                            dayObj['name'] = characterUrl.name;
                            dayObj['rarity'] = characterUrl.rarity;
                            dayObj['vision'] = characterUrl.vision;
                            dayObj['weapon'] = characterUrl.weapon;
                            dayObj['url'] = characterUrl.url;
                            dayObj['rarityBgUrl'] = characterUrl.rarityBgUrl;
                            dayObj['visionUrl'] = characterUrl.visionUrl;
                        }
                    }
                }
                week.push(dayObj);
            }
            weeks.push(week);

            return weeks;
        }

        function getMonthList(year) {
            const result = [];
            for (let month = 0; month < 12; month++) {
                result.push(getDayList(year, month));
            }
            return result;
        }

        async function onLoad() {
            const responses = await Promise.all([
                'data/CharacterMaster.json'
            ].map(s => fetch(s).then(resp => resp.json())));

            キャラクターMaster = responses[0];

            Object.keys(キャラクターMaster).forEach(name => {
                const characterUrl = キャラクターMaster[name]['import'].replace(/^data\/characters/, 'images/characters/face').replace(/json$/, 'png');
                CharacterImageList.push({
                    name: name,
                    rarity: キャラクターMaster[name]['レアリティ'],
                    vision: キャラクターMaster[name]['元素'],
                    weapon: キャラクターMaster[name]['武器'],
                    url: characterUrl,
                    rarityBgUrl: 'images/star' + キャラクターMaster[name]['レアリティ'] + '-bg.png',
                    visionUrl: VISION_IMG_SRC[キャラクターMaster[name]['元素']],
                    birthday: キャラクターMaster[name]['誕生日']
                });
            });

            const year = new Vue({
                el: '#year',
                data: {
                    year: new Date().getFullYear()
                },
                methods: {
                    previous: function () {
                        this.year--;
                        birthdayCalendar.calendar.splice(0, birthdayCalendar.calendar.length, ...getMonthList(this.year));
                    },
                    next: function () {
                        this.year++;
                        birthdayCalendar.calendar.splice(0, birthdayCalendar.calendar.length, ...getMonthList(this.year));
                    }
                }
            });

            const birthdayCalendar = new Vue({
                el: '#birthday-calendar',
                data: {
                    calendar: getMonthList(year.year)
                }
            });

        }

        onLoad();
    </script>
</body>

</html>